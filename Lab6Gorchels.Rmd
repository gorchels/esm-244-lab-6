---
title: "Lab6Gorchels"
author: "Madeline E. Gorchels"
date: "2/13/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Remember to have Becky ask Allison about the trail with the beer 

```{r}
library(tidyverse)
library(sf)
library(tmap)
library(leaflet)
library(ggrepel)
library(ggspatial)
library(RColorBrewer)
library(raster)

```

Goals:

Read in spatial data
Simplify polygons
add and transform projections 
create a bunch of maps
join spatial data
intersections of spatial data
interactive plots
create sf from lat/lon coordinate


###Example 1. Dams in California
Dam name, height, storage information, downstream hazard, etc. 
```{r}
ca_eco = read_sf(".", layer = "ca_eco") %>% 
  dplyr::select(US_L3NAME) %>% 
  rename(Region = US_L3NAME) %>% 
  st_simplify(dTolerance = 100) %>% 
  st_transform(crs=4326) #want to force to coordinate reference system

```


```{r}
ca_counties = read_sf(".", layer = "california_county_shape_file") #need to set a CRS

st_crs(ca_counties) = 4326

```


```{r}
ca_dams = read_sf(".", layer = "California_Jurisdictional_Dams") %>% 
  rename(Condition = Condition_) 

#Now set condition as a factor 
ca_dams$Condition = fct_relevel(ca_dams$Condition, 
                                "Fair", "Satisfactory", "Unsatisfactory", "Poor") #default is alphabetical, make your life easier later 
```

Now lets map

```{r}
plot(ca_eco)
plot(ca_counties)
#clunky to customize 
```
Make a map with ggplot
```{r}

color_count = 13
#Going to make my own pallete
my_colors = colorRampPalette(brewer.pal(10, "Set2"))(color_count) #error message will come, but ramppallette fixed it trust me 
#theme_minimal can be useful 
ggplot(ca_eco)+ 
  geom_sf(aes(fill = Region),
          color = "NA", 
          show.legend = FALSE)+ #gets rid of lines 
  theme_minimal()+
  scale_fill_manual(values = my_colors)+
  geom_sf(data = ca_counties, 
          fill = "NA",
          color = "gray30", 
          size = 0.1)+
  geom_point(data = ca_dams, aes(x = Longitude, y = Latitude), 
             size = 1,
             color = "gray10", 
             alpha = 0.5)+
  coord_sf(datum = NA) #get rid of the lat/lon axis

```

####Example 2. Dams in the Sierra Nevada eco-region

```{r}
sn = ca_eco %>% 
  filter(Region == "Sierra Nevada") %>% 
  st_join(ca_dams)

ggplot(sn)+
  geom_sf(data = ca_counties, fill = "wheat3", color = "NA")+
  theme_minimal()+
  coord_sf(datum = NA)+
  geom_sf(fill = "lemonchiffon4", color = "NA")+
  geom_point(aes(x = Longitude, y = Latitude), 
             size = 0.5, 
             color = "black")


```

###Example 3. Eco-regions for Santa Barbara County 

```{r}
sb = ca_counties %>% 
  filter(NAME == "Santa Barbara") #four rows because there are islands 
eco_clip = st_intersection(ca_eco, sb) #clip the polygon by the sb polygon

ggplot(eco_clip)+
  theme_minimal()+
  coord_sf(datum = NA)+
  geom_sf(data = ca_counties, 
           fill = "gray90",
           color = "gray80",
           size = 0.2)+
  geom_sf(aes(fill = Region), color = "NA")+
  scale_fill_manual(values = c("darkolivegreen2", "darkolivegreen", "gold2"))+
  coord_sf(xlim = c(-121, -119), ylim = c(33.5, 35.5))+ #crops it to a more manageble region
  geom_point(aes(x = -119.6982, y = 34.4208), size = 2) +
  geom_text(x = -119.6982, y = 34.35, label = "Santa Barbara")+
  theme(legend.position = c(0.5, 0.15))


```


###Example 4. Intro to interactive plots with tmap

```{r}

map_sb_eco = tm_shape(eco_clip)+
  tm_fill("Region", pallette = "RdPu", alpha = 0.5)+
  tm_shape(ca_counties)+
  tm_borders()


tmap_mode("view")
map_sb_eco
```


```{r}
#Making a map with a different base map 
tm_basemap("CartoDB.DarkMatter")+
  tm_shape(eco_clip)+
  tm_borders(col= "white")
```

####Example 5. Fault lines
```{r}
#Time to add fault lines <3
fault = read_sf(".", layer = "GMC_str_arc") %>% #there is a prj function so we need to change it 
  st_transform(crs = 4326) %>% 
  separate(LTYPE, into = c("syn_ant", "certainty", "direction"), sep = ",")

ggplot()+
  geom_sf(data = ca_counties, fill = "black", color = "NA")+
  geom_sf(data = fault, aes(color = syn_ant))+
  theme_minimal()+
  coord_sf(datum = NA)

#Fault lines in SB county:

sb_faults = fault %>% 
  st_intersection(sb)

ggplot()+
  geom_sf(data = sb)+
  geom_sf(data = sb_faults, aes(color = syn_ant))

tm_basemap("CartoDB.DarkMatter")+
  tm_shape(sb)+
  tm_borders(col = "gray50", lwd = 2)+
  tm_shape(sb_faults)+
  tm_lines(col = "syn_ant", palette = c("orange", "purple"), lwd = 2)

```

###Example 6. Faceted Maps

```{r}
ggplot()+
  geom_sf(data = ca_counties, fill = "black", color ="NA")+
  geom_sf(data = fault, aes(color = syn_ant))+
  facet_wrap(~syn_ant)
```

###Example 7. Making spatial points

```{r}

ca_sites = read_csv("cadfw_sensitive_sites.csv")

sites_sf = st_as_sf(ca_sites, coords = c("LONDD", "LATDD"), crs = 4326)

ggplot()+
  geom_sf(data = ca_counties, fill = "gray40")+
  geom_sf(data = sites_sf, aes(color = PRI_CODE), size = 0.3)+
  theme_minimal()

```

###Example 8. Chloropleth of CA counties by NUMBER of dams in each county 

```{r}

intersection = st_intersection(ca_dams, ca_counties)

dams_per_county = intersection %>% 
  group_by(NAME) %>% 
  tally()

ca_tot = ca_counties %>% 
  st_join(dams_per_county) %>% 
  dplyr::select(NAME.x, n) %>% 
  rename(name = NAME.x)

ca_tot$n[is.na(ca_tot$n)] <- 0

ggplot() +
  geom_sf(data =ca_tot, aes(fill = n), size = 0.2) +
  theme_minimal() +
  scale_fill_continuous(low = "yellow", high = "red")

```


